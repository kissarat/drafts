<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script>
    const A0 = 440 * 2 ** (-57 / 12)
    const OCTAVE = [0, 2, 4, 5, 7, 9, 11]

    function at(i) {
        return A0 * 2 ** (i / 12)
    }

    function octave(n = 0) {
        const r = []
        for (const m of OCTAVE) {
            r.push(2 ** n * A0 * 2 ** (m / 12))
        }
        return r
    }

    class Range extends Array {
        constructor(audio, array) {
            super(...array)
            this.audio = audio
            this.delay = 0
            this.duration = 1
            this.octave = 4
        }

        set delay(v) {
            if (v > 0) {
                this._delay = v + this.audio.pulse
            }
            else {
                this._delay = 0
            }
        }

        get delay() {
            return this._delay - this.audio.pulse
        }

        set duration(v) {
            this._duration = v + this.audio.pulse
        }

        get duration() {
            return this._duration - this.audio.pulse
        }

        get oscillator() {
            if (!this._oscillator) {
                this._oscillator = this.audio.context.createOscillator()
                this._oscillator.connect(this.audio.context.destination)
                this._oscillator.start(0)
                this.pause(0)
            }
            return this._oscillator
        }

        tune(n) {
            for(let i = 0; i < this.length; i++) {
                this[i] += n
            }
        }

        pause(time = 0) {
            this.oscillator.frequency.setValueAtTime(0, time + this.audio.context.currentTime)
        }

        play(time = 0) {
            const delay = this._delay > 0 ? 2 ** this._delay : 0
            const duration = 2 ** this._duration

            for (const note of this) {
                this.oscillator.frequency.setValueAtTime(at(note + this.octave * 12), time + this.audio.context.currentTime)
                if (delay > 0) {
                    time += delay
                    this.pause(time)
                }
                time += duration
            }
            this.pause(time)
            return time
        }
    }

    class Parallel extends Array {
        play(time = 0) {
            // console.log(time)
            return Math.max(...this.map(r => r.play(time)))
        }
    }

    class Game extends Array {
        constructor(...array) {
            super(...array)
            this.loop = 1000
            this.index = 0
        }

        play(time = 0) {
            if (this.index < this.length) {
                const range = this[this.index++]
                time = range.play(time)
                setTimeout(() => this.play(), time * 1000)
            }
            else if (--this.loop > 0) {
                this.index = 0
                this.play(time)
            }
            return time
        }
    }

    class Audio {
        constructor() {
            this.context = new AudioContext()
            this.pulse = -4
        }

        createRange(array) {
            if ('number' === typeof array) {
                const n = array
                array = []
                for (let i = 0; i < n; i++) {
                    array.push(i)
                }
            }
            const r = new Range(this, array)
            r.audio = this
            return r
        }

        createGroup(...array) {
            return new Parallel(...array)
        }

        play(...array) {
            return new Game(...array)
        }
    }

    const audio = new Audio()
    const a = audio.createRange(4)
    const b = audio.createRange(4).reverse()
    const c = audio.createRange(4).reverse()
    b.tune(-1)
    c.tune(-2)
    // const parallel = audio.createGroup(a, b, c)
    const game = audio.play(a, b, c)
</script>
</body>
</html>
